
# 一、使用java通过Solana Java SDK连接Solana公共节点，实现账户余额查询，转账，erc20合约部署，调用合约方法，事件监听等操作

以下是使用 **Solana Java SDK**（如 [solana-development/solana-java](https://github.com/solana-development/solana-java)）连接 Solana 公共节点，实现常见操作的完整代码示例及流程说明。
或者https://github.com/skynetcap/solanaj
---

### **1. 环境准备**
#### 添加依赖
确保项目中包含 `solana-java` 的依赖（以 Maven 为例）：
```xml
<dependency>
    <groupId>com.solanamobile</groupId>
    <artifactId>solana-java</artifactId>
    <version>最新版本</version> <!-- 替换为实际版本 -->
</dependency>
```

#### 公共节点 RPC 地址
- 主网: `https://api.mainnet-beta.solana.com`
- 测试网: `https://api.testnet.solana.com`

---

### **2. 基础操作实现**
#### **(1) 连接到 Solana 公共节点**
```java
import com.solana.developer.solana.SolanaRpcClient;

SolanaRpcClient rpcClient = new SolanaRpcClient("https://api.mainnet-beta.solana.com");
```

---

#### **(2) 查询账户余额**
```java
import org.bitcoinj.core.Base58;
import com.solana.developer.solana.types.AccountInfo;

public long getBalance(String publicKeyBase58) throws Exception {
    byte[] publicKeyBytes = Base58.decode(publicKeyBase58);
    AccountInfo accountInfo = rpcClient.getAccountInfo(publicKeyBytes);
    return accountInfo.getLamports(); // 返回 lamports 单位（1 SOL = 1_000_000_000 lamports）
}

// 示例调用
long balance = getBalance("Your_PublicKey_Base58");
System.out.println("Balance: " + balance / 1_000_000_000.0 + " SOL");
```

---

#### **(3) SOL 转账**
```java
import com.solana.developer.solana.types.Transaction;
import com.solana.developer.solana.types.Transfer;

public String transferSol(String senderPrivateKeyBase58, String receiverPublicKeyBase58, long lamports) throws Exception {
    byte[] senderPrivateKey = Base58.decode(senderPrivateKeyBase58);
    byte[] receiverPublicKey = Base58.decode(receiverPublicKeyBase58);

    Transfer transfer = new Transfer(
        senderPrivateKey,
        receiverPublicKey,
        lamports
    );
    
    Transaction tx = rpcClient.sendTransaction(transfer);
    return tx.getSignature(); // 返回交易哈希
}

// 示例调用
String txHash = transferSol("Sender_PrivateKey", "Receiver_PublicKey", 1_000_000_000); // 转 1 SOL
System.out.println("Transaction Hash: " + txHash);
```

---

#### **(4) 部署 ERC-20（SPL Token 标准）合约**
Solana 的 Token 合约通过 `spl-token` 程序管理，通常无需手动部署。若需创建新 Token：
```java
import com.solana.developer.solana.token.TokenProgram;

public String createToken(String payerPrivateKeyBase58, long initialSupply) throws Exception {
    byte[] payerPrivateKey = Base58.decode(payerPrivateKeyBase58);
    TokenProgram tokenProgram = new TokenProgram(rpcClient);

    // 创建 Token Mint
    String mintAddress = tokenProgram.createMint(
        payerPrivateKey,
        initialSupply,
        9 // 小数位数
    );
    return mintAddress; // 返回新 Token 的 Mint 地址
}

// 示例调用
String tokenMintAddress = createToken("Payer_PrivateKey", 100_000_000);
System.out.println("Token Mint Address: " + tokenMintAddress);
```

---

#### **(5) 调用合约方法**
以调用 SPL Token 的 `transfer` 方法为例：
```java
public String transferToken(
    String senderPrivateKeyBase58,
    String tokenMintAddress,
    String fromTokenAccount,
    String toTokenAccount,
    long amount
) throws Exception {
    byte[] senderPrivateKey = Base58.decode(senderPrivateKeyBase58);
    TokenProgram tokenProgram = new TokenProgram(rpcClient);

    String txHash = tokenProgram.transfer(
        senderPrivateKey,
        tokenMintAddress,
        fromTokenAccount,
        toTokenAccount,
        amount
    );
    return txHash;
}

// 示例调用
String txHash = transferToken(
    "Sender_PrivateKey",
    "TokenMint_Address",
    "Sender_Token_Account",
    "Receiver_Token_Account",
    100 // 转账数量
);
```

---

#### **(6) 监听合约事件**
监听智能合约（Program）的日志事件：
```java
import com.solana.developer.solana.SolanaWebSocketClient;

public void listenToContractEvents(String programIdBase58) {
    SolanaWebSocketClient wsClient = new SolanaWebSocketClient("wss://api.mainnet-beta.solana.com");
    byte[] programId = Base58.decode(programIdBase58);

    wsClient.logsNotification(programId, log -> {
        System.out.println("Contract Event: " + log);
        // 解析日志中的自定义事件（需与合约代码匹配）
    });
}

// 示例调用
listenToContractEvents("Your_Program_ID");
```

---

### **3. 关键注意事项**
1. **私钥安全**  
   - 避免硬编码私钥，使用环境变量或加密存储。
2. **单位处理**  
   - SOL 单位是 `lamports`（1 SOL = 10^9 lamports）。
   - SPL Token 单位需根据小数位数转换（如 9 位小数时，`amount=100` 表示 0.0000001 Token）。
3. **错误处理**  
   - 所有操作需捕获 `IOException` 或 `SolanaRpcException`。
4. **测试网优先**  
   - 开发阶段建议使用测试网（`https://api.testnet.solana.com`）。

---

### **4. 完整流程示例**
```java
public class SolanaDemo {
    public static void main(String[] args) throws Exception {
        // 初始化 RPC 客户端
        SolanaRpcClient rpcClient = new SolanaRpcClient("https://api.testnet.solana.com");

        // 1. 查询余额
        long balance = rpcClient.getBalance(Base58.decode("Your_PublicKey"));
        System.out.println("Balance: " + balance / 1_000_000_000.0 + " SOL");

        // 2. 转账 SOL
        String txHash = transferSol("Sender_PrivateKey", "Receiver_PublicKey", 500_000_000); // 0.5 SOL
        System.out.println("Tx Hash: " + txHash);

        // 3. 创建 Token
        String tokenMintAddress = createToken("Payer_PrivateKey", 1_000_000_000);
        System.out.println("Token Mint: " + tokenMintAddress);

        // 4. 监听事件
        listenToContractEvents("Your_Program_ID");
    }
}
```

---

### **5. 高级扩展**
- **批量交易**：通过 `TransactionBuilder` 组合多个指令。
- **离线签名**：使用 `KeyPair` 生成签名后广播。
- **合约开发集成**：若需直接与链上程序交互，需通过 Rust 编写合约后用 Java 调用。

通过以上代码，你可以覆盖 Solana 的常见操作。如需进一步优化或深入功能（如 PDA 账户、跨链调用），可参考 [Solana Java SDK 文档](https://github.com/solana-development/solana-java) 或 [Solana 官方文档](https://docs.solana.com/)。



# 二、使用java通过Solana Java SDK连接Solana公共节点，实现账户余额查询，转账，erc20合约部署，调用合约方法，事件监听等操作



在Java中通过Solana Java SDK（如非官方库 `sol4j`）实现账户管理、转账、合约交互及事件监听的完整流程如下：

---

### **1. 依赖配置（Maven）**
```xml
<dependencies>
    <!-- Solana Java SDK (非官方) -->
    <dependency>
        <groupId>com.bmresearch</groupId>
        <artifactId>sol4j</artifactId>
        <version>0.1.0</version>
    </dependency>
    <!-- JSON处理 -->
    <dependency>
        <groupId>com.fasterxml.jackson.core</groupId>
        <artifactId>jackson-databind</artifactId>
        <version>2.16.1</version>
    </dependency>
    <!-- WebSocket客户端 -->
    <dependency>
        <groupId>org.java-websocket</groupId>
        <artifactId>Java-WebSocket</artifactId>
        <version>1.5.3</version>
    </dependency>
</dependencies>
```

---

### **2. 账户余额查询**
```java
import com.bmresearch.sol4j.Solana;
import com.bmresearch.sol4j.model.Account;

public class SolanaDemo {
    public static void main(String[] args) throws Exception {
        // 连接公共节点
        Solana solana = new Solana("https://api.mainnet-beta.solana.com");

        // 生成新账户（或使用已有私钥）
        Account account = Account.newRandom();

        // 查询余额
        long balance = solana.getBalance(account.getPublicKey());
        System.out.println("账户余额: " + balance / Math.pow(10, 9) + " SOL");
    }
}
```

---

### **3. 转账操作**
```java
import com.bmresearch.sol4j.Solana;
import com.bmresearch.sol4j.model.Account;
import com.bmresearch.sol4j.model.Transaction;

public class Transfer {
    public static void main(String[] args) throws Exception {
        Solana solana = new Solana("https://api.mainnet-beta.solana.com");
        Account from = Account.newRandom(); // 发送方账户
        Account to = Account.newRandom();   // 接收方账户

        // 构建转账交易
        Transaction tx = Transaction.transfer(
            from.getPublicKey(),
            to.getPublicKey(),
            0.1 * Math.pow(10, 9) // 转账金额（单位：SOL）
        );

        // 签名并发送交易
        String txId = solana.sendTransaction(tx, from);
        System.out.println("交易ID: " + txId);
    }
}
```

---

### **4. ERC20合约部署与交互**
Solana原生不支持以太坊风格的ERC20，但可通过其代币程序（Token Program）实现类似功能：

#### **4.1 部署代币合约**
需使用Rust编写并部署代币程序（参考 [Solana Token Program](https://github.com/solana-labs/solana-program-library/tree/master/token)），Java仅作为客户端调用。

#### **4.2 调用代币合约方法**
```java
import com.bmresearch.sol4j.Solana;
import com.bmresearch.sol4j.model.Account;
import com.bmresearch.sol4j.model.Program;

public class TokenDemo {
    public static void main(String[] args) throws Exception {
        Solana solana = new Solana("https://api.mainnet-beta.solana.com");
        Account payer = Account.newRandom();
        Account mintAuthority = Account.newRandom();

        // 调用代币程序创建Mint账户
        Program.TokenProgram tokenProgram = Program.TokenProgram.INSTANCE;
        Account mintAccount = Account.newRandom();

        // 初始化Mint（类似部署合约）
        tokenProgram.initializeMint(
            mintAccount,          // Mint账户
            9,                    // 小数位数
            mintAuthority,        // 铸币权限
            null                  // 冻结权限（可选）
        );

        // 发送交易
        String txId = solana.sendTransaction(
            tokenProgram.getLatestTransaction(), 
            payer, 
            mintAccount
        );
        System.out.println("Mint初始化交易ID: " + txId);
    }
}
```

---

### **5. 事件监听（WebSocket）**
通过订阅程序日志或账户变更实现事件监听：

#### **5.1 使用WebSocket订阅程序日志**
```java
import org.java_websocket.client.WebSocketClient;
import org.java_websocket.handshake.ServerHandshake;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;

import java.net.URI;

public class EventListener extends WebSocketClient {
    private static final ObjectMapper objectMapper = new ObjectMapper();

    public EventListener(URI serverUri) {
        super(serverUri);
    }

    @Override
    public void onOpen(ServerHandshake handshake) {
        // 发送订阅请求（订阅特定程序的日志）
        String request = "{"
            + "\"jsonrpc\": \"2.0\","
            + "\"id\": 1,"
            + "\"method\": \"programSubscribe\","
            + "\"params\": [\"TokenkegQfeZyiNwAJbNbGKL6QfwB8GgV6w9g8qj1Jp1\"]" // Token Program ID
            + "}";
        this.send(request);
    }

    @Override
    public void onMessage(String message) {
        try {
            JsonNode response = objectMapper.readTree(message);
            // 解析日志事件（如Transfer、Mint等）
            System.out.println("接收到事件: " + response);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    public static void main(String[] args) throws Exception {
        EventListener client = new EventListener(new URI("wss://api.mainnet-beta.solana.com"));
        client.connect();
    }
}
```

---

### **注意事项**
1. **合约部署限制**  
   Solana合约必须用Rust/C编写并部署，Java仅用于链下交互。需先通过 `solana program deploy` 部署Rust程序。

2. **密钥管理**  
   私钥需安全存储（如环境变量或加密文件），避免硬编码。

3. **Gas费用**  
   所有操作需支付SOL作为手续费，确保账户有足够余额。

4. **网络选择**  
   测试时可使用 `https://api.devnet.solana.com` 和空投工具获取测试SOL。

---

### **替代方案**
若需更高效的开发体验，建议：
1. 使用Rust编写合约，Java作为客户端。
2. 通过 `@solana/web3.js`（Node.js库）实现复杂交互，再通过JNI调用Java。
