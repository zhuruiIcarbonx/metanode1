
# 一、使用java通过Web3j连接Infura以太坊公共节点，实现账户余额查询，转账，erc20合约部署，调用合约方法，事件监听等操作

以下是使用Java和Web3j连接Infura以太坊节点，实现常见区块链操作的完整代码示例，涵盖账户查询、ETH转账、ERC20合约部署与交互等场景。

---

### **1. 环境准备**
#### 依赖（Maven）
```xml
<dependency>
    <groupId>org.web3j</groupId>
    <artifactId>core</artifactId>
    <version>4.9.8</version>
</dependency>
<dependency>
    <groupId>org.web3j</groupId>
    <artifactId>contracts</artifactId>
    <version>4.9.8</version>
</dependency>
```

#### Infura配置
```java
// 替换为你的Infura项目ID
String infuraUrl = "https://mainnet.infura.io/v3/YOUR_INFURA_PROJECT_ID";
Web3j web3j = Web3j.build(new HttpService(infuraUrl));
```

---

### **2. 查询ETH余额**
```java
import org.web3j.protocol.core.DefaultBlockParameterName;

String address = "0xYourAddress"; // 要查询的地址
BigInteger balance = web3j.ethGetBalance(address, DefaultBlockParameterName.LATEST)
        .send()
        .getBalance();
System.out.println("ETH余额: " + Convert.fromWei(balance.toString(), Convert.Unit.ETHER));
```

---

### **3. ETH转账**
```java
import org.web3j.crypto.Credentials;
import org.web3j.tx.RawTransactionManager;
import org.web3j.utils.Convert;

// 发送方私钥（测试时建议使用测试网私钥，勿暴露主网私钥）
String privateKey = "0xYourPrivateKey";
Credentials credentials = Credentials.create(privateKey);

// 转账参数
String toAddress = "0xRecipientAddress";
BigDecimal amount = BigDecimal.valueOf(0.1); // 转账0.1 ETH
BigInteger gasPrice = Convert.toWei("20", Convert.Unit.GWEI).toBigInteger();
BigInteger gasLimit = BigInteger.valueOf(21000L);

// 发送交易
RawTransactionManager txManager = new RawTransactionManager(web3j, credentials);
String txHash = txManager.sendTransaction(
        gasPrice,
        gasLimit,
        toAddress,
        Convert.toWei(amount, Convert.Unit.ETHER).toBigInteger().toString(),
        ""
).getTransactionHash();
System.out.println("交易哈希: " + txHash);
```

---

### **4. 部署ERC20合约**
#### 步骤1：准备Solidity合约（示例ERC20）
```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract MyToken {
    string public name = "MyToken";
    string public symbol = "MTK";
    uint8 public decimals = 18;
    uint256 public totalSupply;
    mapping(address => uint256) public balanceOf;

    constructor(uint256 initialSupply) {
        totalSupply = initialSupply * 10 ** uint256(decimals);
        balanceOf[msg.sender] = totalSupply;
    }
}
```
#### 步骤2：使用Web3j部署
```java
import org.web3j.protocol.core.methods.response.TransactionReceipt;
import org.web3j.tx.gas.DefaultGasProvider;

// 编译合约后获取bin和abi
String contractBin = "608060405234801561001057600080fd5b50..."; // 替换为实际bin
String contractAbi = "[{\"inputs\":[{\"internalType\":\"uint256\",\"name\":..."; // 替换为实际abi

// 部署合约
MyToken contract = MyToken.deploy(
        web3j,
        credentials,
        new DefaultGasProvider(),
        contractBin,
        contractAbi,
        BigInteger.valueOf(1000000) // 初始供应量1,000,000
).send();

String contractAddress = contract.getContractAddress();
System.out.println("合约地址: " + contractAddress);
```

---

### **5. 调用ERC20合约方法**
#### 查询代币余额
```java
BigInteger balance = contract.balanceOf("0xSomeAddress").send();
System.out.println("代币余额: " + balance);
```

#### 转账代币
```java
TransactionReceipt receipt = contract.transfer(
        "0xRecipientAddress",
        Convert.toWei("10", Convert.Unit.ETHER).toBigInteger()
).send();
System.out.println("转账成功，交易哈希: " + receipt.getTransactionHash());
```

---

### **6. 监听合约事件**
```java
import org.web3j.protocol.core.methods.response.EthBlock;
import org.web3j.protocol.core.methods.response.Log;

// 监听Transfer事件
contract.transferEventFlowable(
        DefaultBlockParameterName.EARLIEST,
        DefaultBlockParameterName.LATEST
).subscribe(event -> {
    System.out.println("转账事件:");
    System.out.println("From: " + event.from);
    System.out.println("To: " + event.to);
    System.out.println("Value: " + event.value);
}, Throwable::printStackTrace);
```

---

### **关键注意事项**
1. **私钥安全**  
   - 切勿将主网私钥硬编码在代码中，建议从环境变量或加密存储读取。

2. **Gas管理**  
   - 动态获取Gas价格（如`web3j.ethGasPrice().send().getGasPrice()`）。

3. **错误处理**  
   - 捕获`IOException`和`TransactionException`等异常。

4. **测试网优先**  
   - 先在Ropsten/Rinkeby等测试网测试，再切换至主网。

5. **合约ABI更新**  
   - 合约升级后需重新生成Java封装类。

---

### **完整项目结构建议**
```
src/
├── main/
│   ├── java/
│   │   ├── com/example/
│   │   │   ├── EthereumService.java  // 核心交互逻辑
│   │   │   ├── MyToken.java          // Web3j生成的合约封装类
│   ├── resources/
│   │   ├── MyToken.abi               // 合约ABI文件
│   │   ├── config.properties         // Infura配置
```

如果需要更详细的某部分实现（如动态Gas计算），可以进一步说明！

# 一、XXXXXXXXXXXXXXXXXXXXXX




以下是使用 Java 通过 Web3j 连接 Infura 以太坊公共节点实现账户余额查询、转账、ERC20 合约部署、调用合约方法及事件监听的完整示例：

---

### **1. 依赖配置（Maven）**
```xml
<dependencies>
    <!-- Web3j 核心库 -->
    <dependency>
        <groupId>org.web3j</groupId>
        <artifactId>core</artifactId>
        <version>4.8.4</version> <!-- 使用最新版本 -->
    </dependency>
    <!-- 以太坊账户工具 -->
    <dependency>
        <groupId>org.web3j</groupId>
        <artifactId>crypto</artifactId>
        <version>4.8.4</version>
    </dependency>
</dependencies>
```

---

### **2. 连接 Infura 节点**
```java
import org.web3j.protocol.Web3j;
import org.web3j.protocol.http.HttpService;

public class EthereumClient {
    public static void main(String[] args) throws Exception {
        // 替换为你的 Infura 项目 URL（主网或测试网）
        String infuraUrl = "https://mainnet.infura.io/v3/YOUR_INFURA_PROJECT_ID";
        Web3j web3j = Web3j.build(new HttpService(infuraUrl));
        
        // 检查连接状态
        if (web3j.web3ClientVersion().send().hasResult()) {
            System.out.println("成功连接以太坊节点！");
        }
    }
}
```

---

### **3. 查询账户余额**
```java
import org.web3j.protocol.core.methods.response.EthGetBalance;
import java.math.BigInteger;

public class BalanceChecker {
    public static void checkBalance(Web3j web3j, String address) throws Exception {
        EthGetBalance balance = web3j.ethGetBalance(address, DefaultBlockParameterName.LATEST).send();
        BigInteger wei = balance.getBalance();
        System.out.println("账户余额（Wei）: " + wei);
        System.out.println("账户余额（ETH）: " + Convert.fromWei(wei.toString(), Convert.Unit.ETHER));
    }
}
```

---

### **4. 发起 ETH 转账**
```java
import org.web3j.protocol.core.methods.request.RawTransaction;
import org.web3j.protocol.core.methods.response.EthSendTransaction;
import org.web3j.crypto.Credentials;
import org.web3j.crypto.RawTransactionEncoder;
import org.web3j.utils.Numeric;

public class Transfer {
    public static void sendEth(Web3j web3j, String fromPrivateKey, String toAddress, BigDecimal amountInEth) throws Exception {
        // 加载发送方账户
        Credentials credentials = Credentials.create(fromPrivateKey);
        
        // 获取 nonce
        BigInteger nonce = web3j.ethGetTransactionCount(
            credentials.getAddress(), DefaultBlockParameterName.LATEST).send().getTransactionCount();
        
        // 设置 Gas 价格和上限
        BigInteger gasPrice = web3j.ethGasPrice().send().getGasPrice(); // 自动获取当前 Gas 价格
        BigInteger gasLimit = BigInteger.valueOf(21000); // 标准转账 Gas 上限
        
        // 创建交易
        RawTransaction transaction = RawTransaction.createEtherTransaction(
            nonce, gasPrice, gasLimit, toAddress, amountInEth.toBigIntegerExact());
        
        // 签名交易
        byte[] signedMessage = RawTransactionEncoder.encode(transaction, credentials);
        String hexValue = Numeric.toHexString(signedMessage);
        
        // 发送交易
        EthSendTransaction transactionResponse = web3j.ethSendRawTransaction(hexValue).send();
        System.out.println("交易哈希: " + transactionResponse.getTransactionHash());
    }
}
```

---

### **5. 部署 ERC20 合约**
假设你有一个 Solidity 编写的 ERC20 合约（如 `MyToken.sol`），编译后生成 `bin` 和 `abi` 文件。使用 Web3j 生成 Java 包装类：
```bash
web3j generate solidity -a MyToken.abi -b MyToken.bin -o ./src/main/java -p com.example.contract
```

部署合约：
```java
import com.example.contract.MyToken;
import org.web3j.tx.gas.DefaultGasProvider;

public class DeployERC20 {
    public static void deployContract(Web3j web3j, String privateKey) throws Exception {
        Credentials credentials = Credentials.create(privateKey);
        MyToken contract = MyToken.deploy(
            web3j, credentials,
            new DefaultGasProvider(), // 使用默认 Gas 配置
            BigInteger.valueOf(1000000) // 构造函数参数（例如初始供应量）
        ).send();
        System.out.println("合约地址: " + contract.getContractAddress());
    }
}
```

---

### **6. 调用合约方法**
假设合约中有一个 `transfer` 方法：
```java
public class ContractInteraction {
    public static void transferToken(Web3j web3j, String privateKey, String contractAddress) throws Exception {
        Credentials credentials = Credentials.create(privateKey);
        MyToken contract = MyToken.load(contractAddress, web3j, credentials, new DefaultGasProvider());
        
        // 调用 transfer 方法
        TransactionReceipt receipt = contract.transfer("0x RECEIVER_ADDRESS", BigInteger.valueOf(100)).send();
        System.out.println("交易状态: " + receipt.isStatusOK());
    }
}
```

---

### **7. 监听合约事件**
在合约中定义事件（如 `Transfer`），然后通过 `flowable` 监听：
```java
public class EventListener {
    public static void listenToTransfers(Web3j web3j, String contractAddress) throws Exception {
        MyToken contract = MyToken.load(contractAddress, web3j, Credentials.create("DUMMY_PRIVATE_KEY"), new DefaultGasProvider());
        
        contract.transferEventFlowable(
            DefaultBlockParameterName.LATEST, DefaultBlockParameterName.PENDING)
            .subscribe(event -> {
                System.out.println("From: " + event._from);
                System.out.println("To: " + event._to);
                System.out.println("Amount: " + event._value);
            });
    }
}
```

---

### **关键注意事项**
1. **私钥安全**：避免硬编码私钥，使用环境变量或密钥管理服务（如 Hashicorp Vault）。
2. **Gas 管理**：
   - Gas 价格可通过 `web3j.ethGasPrice().send().getGasPrice()` 动态获取。
   - Gas 上限需根据合约复杂度调整（简单转账为 21000，合约交互通常更高）。
3. **网络选择**：
   - Infura URL 格式：`https://mainnet.infura.io/v3/<PROJECT_ID>`（主网）或 `https://rinkeby.infura.io/v3/<PROJECT_ID>`（测试网）。
4. **错误处理**：
   - 交易失败时检查 `TransactionReceipt.getStatus()`。
   - 捕获异常（如 `InterruptedException`, `ExecutionException`）。

---

### **完整流程示例**
```java
public class Main {
    public static void main(String[] args) throws Exception {
        Web3j web3j = EthereumClient.connectToInfura();
        String senderPrivateKey = "YOUR_PRIVATE_KEY";
        String receiverAddress = "0x RECEIVER_ADDRESS";
        
        // 1. 查询余额
        BalanceChecker.checkBalance(web3j, Credentials.create(senderPrivateKey).getAddress());
        
        // 2. 发送 ETH
        Transfer.sendEth(web3j, senderPrivateKey, receiverAddress, new BigDecimal("0.1"));
        
        // 3. 部署 ERC20 合约
        String contractAddress = DeployERC20.deployContract(web3j, senderPrivateKey);
        
        // 4. 调用合约方法
        ContractInteraction.transferToken(web3j, senderPrivateKey, contractAddress);
        
        // 5. 监听事件
        EventListener.listenToTransfers(web3j, contractAddress);
    }
}
```

通过上述步骤，你可以实现完整的以太坊交互功能。实际开发中需结合日志记录、重试机制和安全策略（如私钥加密存储）来增强健壮性。
