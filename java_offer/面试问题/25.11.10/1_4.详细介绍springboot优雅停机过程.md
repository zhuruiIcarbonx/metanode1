
# 一、详细介绍springboot优雅停机过程

在 Spring Boot 应用中，**优雅停机（Graceful Shutdown）** 是指在应用关闭时，确保已完成的任务正常处理、未完成的请求有序完成，并释放资源（如数据库连接、线程池等），避免数据丢失或服务中断。以下是 Spring Boot 优雅停机的详细实现过程：

---

### **1. 基本原理**
优雅停机通过监听应用关闭信号（如 `SIGTERM`），在进程终止前执行以下操作：
- 拒绝新请求（如 HTTP 请求、消息队列消费）。
- 等待正在处理的请求完成。
- 关闭资源（线程池、数据库连接池等）。

---

### **2. 实现步骤**

#### **(1) 开启优雅停机（Spring Boot 2.3+）**
Spring Boot 2.3+ 内置优雅停机支持，只需通过配置文件启用：
```properties
# application.properties
server.shutdown=graceful  # 开启优雅停机
spring.lifecycle.timeout-per-shutdown-phase=30s  # 设置等待超时时间（默认30秒）
```

#### **(2) 监听关闭事件**
通过实现 `ApplicationListener` 或注解 `@PreDestroy` 自定义关闭逻辑：
```java
@Component
public class GracefulShutdownListener implements ApplicationListener<ContextClosedEvent> {
    @Override
    public void onApplicationEvent(ContextClosedEvent event) {
        // 自定义资源释放逻辑（如关闭线程池）
    }
}
```

#### **(3) 处理线程池和任务**
确保异步任务（如 `@Async`、线程池）在关闭时完成：
```java
@Bean(destroyMethod = "shutdown")
public ExecutorService taskExecutor() {
    return Executors.newFixedThreadPool(10);
}
```

#### **(4) 配合外部组件**
- **HTTP 请求**：Spring Boot 会自动停止接收新请求，等待处理中的请求完成。
- **数据库连接池**：配置连接池的 `destroy-method`（如 HikariCP 的 `close`）。
- **消息队列（如RabbitMQ）**：停止监听队列，确保消息不丢失。

---

### **3. 验证优雅停机**
#### **(1) 手动触发关闭**
发送 `SIGTERM` 信号（非 `SIGKILL`）：
```bash
kill -TERM <SpringBoot进程PID>
```

#### **(2) 观察日志**
正常停机日志应包含：
```
2025-11-11 10:47:00 INFO  [Thread-1] o.s.b.w.e.tomcat.GracefulShutdown : Commencing graceful shutdown...
2025-11-11 10:47:00 INFO  [Thread-1] o.s.b.w.e.tomcat.GracefulShutdown : Waiting for active requests to complete...
2025-11-11 10:47:25 INFO  [Thread-1] o.s.b.w.e.tomcat.GracefulShutdown : Graceful shutdown complete.
```

#### **(3) 超时处理**
若未在 `timeout-per-shutdown-phase` 内完成，会强制关闭并记录警告。

---

### **4. 高级场景**
#### **(1) Kubernetes 探针配置**
在 K8s 中，需配置 `lifecycle` 和 `readinessProbe`：
```yaml
spec:
  containers:
    - name: app
      lifecycle:
        preStop:
          exec:
            command: ["sh", "-c", "sleep 10"]  # 预留时间完成优雅停机
      readinessProbe:
        httpGet:
          path: /actuator/health/readiness
```

#### **(2) Actuator 端点监控**
通过 `/actuator/health` 观察应用状态：
```properties
management.endpoint.health.probes.enabled=true
```

---

### **5. 注意事项**
- **避免长耗时任务**：确保业务逻辑不会阻塞停机流程。
- **分布式系统协调**：在微服务中需结合注册中心（如Eureka）主动注销服务。
- **信号处理**：确保程序能正确接收 `SIGTERM`（容器中可能需包装启动脚本）。

---

通过上述步骤，Spring Boot 应用可以实现平滑关闭，兼顾服务可靠性和用户体验。如需进一步优化，可根据业务需求调整超时时间或扩展关闭阶段的钩子逻辑。


# 一、详细介绍springboot优雅停机过程

Spring Boot 从 2.3 版本开始引入了**优雅停机（Graceful Shutdown）**功能，主要用于在应用关闭时，避免正在处理的请求被 abrupt 中断，确保正在进行的请求能够正常完成处理，同时不再接收新的请求，从而实现服务的平滑下线。这对于微服务架构、云原生部署（如 Kubernetes）等场景尤为重要。

以下是 Spring Boot 优雅停机的详细过程和机制说明：

---

### 一、优雅停机的核心目标

1. **停止接收新请求**：关闭服务器端口的监听，不再接受新的 HTTP 请求。
2. **完成正在进行的请求**：允许正在处理的请求继续执行，直到完成或超时。
3. **释放资源**：在请求处理完成后，关闭线程池、数据库连接、消息队列连接等资源。
4. **避免数据丢失或状态不一致**：防止因强制关闭导致事务未提交、消息丢失等问题。

---

### 二、支持的服务器类型

Spring Boot 的优雅停机主要支持以下嵌入式 Web 服务器：

- **Tomcat**（默认）
- **Jetty**
- **Undertow**

不同服务器在实现细节上略有差异，但整体流程一致。

---

### 三、配置方式

在 `application.yml` 或 `application.properties` 中启用并配置优雅停机：

```yaml
server:
  shutdown: graceful  # 启用优雅停机
  tomcat:
    shutdown: graceful  # Tomcat 特有配置（可选）
spring:
  lifecycle:
    timeout-per-shutdown-phase: 30s  # 最大等待时间，超过则强制关闭
```

> ⚠️ 注意：`timeout-per-shutdown-phase` 是关键参数，表示 Spring 容器等待每个关闭阶段的最大时间。如果在此时间内请求未完成，剩余请求将被强制中断。

---

### 四、优雅停机的执行流程

当触发关闭命令（如 `kill -15 <pid>`、`CTRL+C`、K8s 发送 SIGTERM）时，Spring Boot 执行以下步骤：

#### 1. **触发关闭事件**
JVM 接收到 `SIGTERM` 信号，Spring 的 `Lifecycle` 机制启动关闭流程，发布 `ContextClosedEvent`。

#### 2. **Web 服务器进入“停机模式”**
- Tomcat/Jetty/Undertow 停止接受新请求。
- 已建立的连接可以继续处理当前请求。
- 新的 TCP 连接将被拒绝。

#### 3. **等待活跃请求完成**
Spring 会等待所有正在处理的请求完成，最长等待时间为 `spring.lifecycle.timeout-per-shutdown-phase`。

- 在此期间，Spring 不会处理新的请求。
- 每个请求线程继续执行，直到返回响应。

#### 4. **超时处理**
如果在指定时间内仍有请求未完成，Spring 将强制关闭服务器，中断剩余请求。

> 例如：设置 `30s` 超时，若某请求已运行 25s，还剩 10s 才能完成，则会被中断。

#### 5. **关闭 Spring 容器**
- 调用 `DisposableBean`、`@PreDestroy` 注解的方法。
- 关闭线程池、DataSource、RabbitMQ/Kafka 连接等资源。
- 销毁 Bean，释放内存。

#### 6. **JVM 退出**
所有资源释放后，JVM 正常退出。

---

### 五、实际触发方式

#### 1. **命令行关闭**
```bash
kill -15 <pid>   # 推荐，触发优雅停机
kill -9 <pid>    # 强制杀死，不触发优雅停机
```

#### 2. **Kubernetes 环境**
K8s 在 Pod 删除时会发送 `SIGTERM`，配合优雅停机可实现零 downtime 滚动更新。

```yaml
apiVersion: apps/v1
kind: Deployment
spec:
  strategy:
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  template:
    spec:
      terminationGracePeriodSeconds: 60  # 给足时间完成优雅停机
```

> 建议 `terminationGracePeriodSeconds > spring.lifecycle.timeout-per-shutdown-phase`

---

### 六、监控与日志

Spring Boot Actuator 提供了关闭端点（需启用）：

```yaml
management:
  endpoint:
    shutdown:
      enabled: true
  endpoints:
    web:
      exposure:
        include: shutdown
```

可通过 `POST /actuator/shutdown` 触发关闭（生产环境慎用）。

日志中会输出类似信息：
```
INFO  o.s.b.w.embedded.tomcat.TomcatWebServer - Stopping web server...
INFO  o.s.c.support.DefaultLifecycleProcessor - Stopping beans in phase 2147483647
INFO  o.s.b.w.embedded.tomcat.TomcatWebServer - Graceful shutdown completed
```

---

### 七、注意事项

1. **避免长时间阻塞请求**：如大文件下载、长轮询等，建议设置合理的超时。
2. **异步任务处理**：`@Async` 方法或线程池任务不会被自动等待，需自行管理生命周期。
3. **消息队列消费者**：需结合 `SimpleMessageListenerContainer` 的 `stop()` 方法实现优雅停止。
4. **数据库事务**：确保事务能在超时时间内提交或回滚。

---

### 八、总结

| 特性 | 说明 |
|------|------|
| 支持版本 | Spring Boot 2.3+ |
| 核心配置 | `server.shutdown=graceful` + `spring.lifecycle.timeout-per-shutdown-phase` |
| 触发信号 | `SIGTERM`（`kill -15`） |
| 不支持 | `SIGKILL`（`kill -9`） |
| 适用场景 | 微服务、K8s、蓝绿发布、滚动更新 |

---

通过合理配置优雅停机，可以显著提升服务的稳定性和用户体验，是现代云原生应用不可或缺的一环。
