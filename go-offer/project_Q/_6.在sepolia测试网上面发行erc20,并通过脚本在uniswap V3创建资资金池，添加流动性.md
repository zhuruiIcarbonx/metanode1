好的，我来详细说明如何在Sepolia测试网上发行ERC20代币，并通过脚本在Uniswap V3上创建资金池和添加流动性。

## 1. 环境准备

首先安装必要的依赖：

```bash
npm init -y
npm install --save-dev hardhat
npm install @openzeppelin/contracts
npm install @uniswap/v3-core
npm install @uniswap/v3-periphery
npm install ethers
npm install dotenv
```

## 2. 创建Hardhat项目配置

**hardhat.config.js**
```javascript
require("@nomicfoundation/hardhat-toolbox");
require("dotenv").config();

module.exports = {
  solidity: "0.8.19",
  networks: {
    sepolia: {
      url: `https://sepolia.infura.io/v3/${process.env.INFURA_API_KEY}`,
      accounts: [process.env.PRIVATE_KEY]
    }
  }
};
```

## 3. 创建ERC20代币合约

**contracts/MyToken.sol**
```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.19;

import "@openzeppelin/contracts/token/ERC20/ERC20.sol";

contract MyToken is ERC20 {
    constructor(string memory name, string memory symbol, uint256 initialSupply) ERC20(name, symbol) {
        _mint(msg.sender, initialSupply * 10**decimals());
    }
}
```

## 4. 部署脚本

**scripts/deploy.js**
```javascript
const { ethers } = require("hardhat");

async function main() {
  const [deployer] = await ethers.getSigners();
  console.log("Deploying contracts with account:", deployer.address);

  // 部署ERC20代币
  const MyToken = await ethers.getContractFactory("MyToken");
  const myToken = await MyToken.deploy("My Test Token", "MTT", 1000000); // 100万代币
  
  await myToken.deployed();
  console.log("MyToken deployed to:", myToken.address);

  // 保存合约地址到文件，供后续脚本使用
  const fs = require('fs');
  const addresses = {
    myToken: myToken.address
  };
  fs.writeFileSync('deployed-addresses.json', JSON.stringify(addresses, null, 2));
  
  console.log("Deployment completed!");
}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error(error);
    process.exit(1);
  });
```

## 5. Uniswap V3池子创建和流动性添加脚本

**scripts/createPoolAndAddLiquidity.js**
```javascript
const { ethers } = require("hardhat");
const { Token } = require('@uniswap/sdk-core');
const { Pool, Position, NonfungiblePositionManager } = require('@uniswap/v3-sdk');
const IUniswapV3PoolABI = require('@uniswap/v3-core/artifacts/contracts/interfaces/IUniswapV3Pool.sol/IUniswapV3Pool.json');
const INonfungiblePositionManagerABI = require('@uniswap/v3-periphery/artifacts/contracts/interfaces/INonfungiblePositionManager.sol/INonfungiblePositionManager.json');

// Uniswap V3 Sepolia地址
const UNISWAP_V3_FACTORY = '0x0227628f3F023bb0B980b67D528571c95c6DaC1c';
const NONFUNGIBLE_POSITION_MANAGER = '0x1238536071E1c677A632429e3655c799b22cDA52';
const WETH_SEPOLIA = '0xfFf9976782d46CC05630D1f6eBAb18b2324d6B14';

async function main() {
  const [owner] = await ethers.getSigners();
  console.log("Operating with account:", owner.address);

  // 读取已部署的代币地址
  const addresses = require('../deployed-addresses.json');
  const myTokenAddress = addresses.myToken;
  
  const MyToken = await ethers.getContractFactory("MyToken");
  const myToken = await MyToken.attach(myTokenAddress);
  
  const weth = await ethers.getContractAt("IERC20", WETH_SEPOLIA);
  
  // 获取代币信息
  const myTokenName = await myToken.name();
  const myTokenSymbol = await myToken.symbol();
  const myTokenDecimals = await myToken.decimals();
  
  console.log(`Token: ${myTokenName} (${myTokenSymbol})`);
  console.log(`Decimals: ${myTokenDecimals}`);
  console.log(`Balance: ${await myToken.balanceOf(owner.address)}`);

  // 创建代币实例用于Uniswap SDK
  const TokenA = new Token(11155111, myTokenAddress, myTokenDecimals, myTokenSymbol, myTokenName);
  const TokenB = new Token(11155111, WETH_SEPOLIA, 18, 'WETH', 'Wrapped Ether');

  // 获取NonfungiblePositionManager合约实例
  const nonfungiblePositionManager = new ethers.Contract(
    NONFUNGIBLE_POSITION_MANAGER,
    INonfungiblePositionManagerABI.abi,
    owner
  );

  // 步骤1: 创建资金池
  console.log("\n1. Creating pool...");
  
  // 选择手续费等级 (500 = 0.05%, 3000 = 0.3%, 10000 = 1%)
  const fee = 3000;
  
  // 获取池子地址
  const poolAddress = await nonfungiblePositionManager.callStatic.createAndInitializePoolIfNecessary(
    TokenA.address,
    TokenB.address,
    fee,
    ethers.utils.parseUnits('1.0', 18) // 初始价格: 1 MTT = 1 WETH
  );
  
  console.log(`Pool created at: ${poolAddress}`);

  // 步骤2: 批准代币使用
  console.log("\n2. Approving tokens...");
  
  const approveAmount = ethers.utils.parseUnits('1000', myTokenDecimals);
  
  // 批准MyToken
  const approveTx1 = await myToken.approve(NONFUNGIBLE_POSITION_MANAGER, approveAmount);
  await approveTx1.wait();
  console.log("MyToken approved");
  
  // 批准WETH (需要一些WETH用于测试)
  const wethAmount = ethers.utils.parseEther('0.1');
  const approveTx2 = await weth.approve(NONFUNGIBLE_POSITION_MANAGER, wethAmount);
  await approveTx2.wait();
  console.log("WETH approved");

  // 步骤3: 添加流动性
  console.log("\n3. Adding liquidity...");
  
  // 定义价格范围 (以WETH计价的MyToken价格)
  const lowerPrice = ethers.utils.parseUnits('0.5', 18);  // 0.5 WETH per MTT
  const upperPrice = ethers.utils.parseUnits('2.0', 18);  // 2.0 WETH per MTT
  
  const liquidityParams = {
    token0: TokenA.address,
    token1: TokenB.address,
    fee: fee,
    tickLower: getTickFromPrice(lowerPrice, 18),
    tickUpper: getTickFromPrice(upperPrice, 18),
    amount0Desired: ethers.utils.parseUnits('100', myTokenDecimals), // 100 MTT
    amount1Desired: ethers.utils.parseEther('0.1'), // 0.1 WETH
    amount0Min: 0,
    amount1Min: 0,
    recipient: owner.address,
    deadline: Math.floor(Date.now() / 1000) + 60 * 20 // 20分钟
  };

  console.log("Adding liquidity with params:", {
    token0: liquidityParams.token0,
    token1: liquidityParams.token1,
    amount0: liquidityParams.amount0Desired.toString(),
    amount1: liquidityParams.amount1Desired.toString()
  });

  const mintTx = await nonfungiblePositionManager.mint(liquidityParams);
  const mintReceipt = await mintTx.wait();
  
  console.log("Liquidity added! Transaction hash:", mintReceipt.transactionHash);

  // 获取NFT位置ID
  const transferEvent = mintReceipt.events.find(event => event.event === 'Transfer');
  const tokenId = transferEvent.args.tokenId;
  console.log(`NFT Position ID: ${tokenId}`);

  console.log("\n✅ All operations completed successfully!");
}

// 辅助函数：从价格计算tick
function getTickFromPrice(price, decimals) {
  // 这是一个简化的计算，实际应该使用更精确的数学计算
  const priceFloat = parseFloat(ethers.utils.formatUnits(price, decimals));
  return Math.floor(Math.log(priceFloat) / Math.log(1.0001));
}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error(error);
    process.exit(1);
  });
```

## 6. 环境变量配置

创建 **.env** 文件：
```env
INFURA_API_KEY=your_infura_api_key
PRIVATE_KEY=your_wallet_private_key
```

## 7. 执行步骤

### 步骤1: 部署ERC20代币
```bash
npx hardhat run scripts/deploy.js --network sepolia
```

### 步骤2: 获取测试WETH
在Sepolia测试网，你需要一些WETH来提供流动性：
- 访问Sepolia WETH faucet: https://sepolia.etherscan.io/address/0xfff9976782d46cc05630d1f6ebab18b2324d6b14#writeContract
- 调用 `deposit` 函数，发送一些Sepolia ETH来获取WETH

### 步骤3: 创建池子和添加流动性
```bash
npx hardhat run scripts/createPoolAndAddLiquidity.js --network sepolia
```

## 8. 验证脚本

创建验证脚本 **scripts/verify.js**：
```javascript
const { ethers } = require("hardhat");

async function main() {
  const [owner] = await ethers.getSigners();
  const addresses = require('./deployed-addresses.json');
  
  const MyToken = await ethers.getContractFactory("MyToken");
  const myToken = await MyToken.attach(addresses.myToken);
  
  console.log("Token Info:");
  console.log("Name:", await myToken.name());
  console.log("Symbol:", await myToken.symbol());
  console.log("Total Supply:", (await myToken.totalSupply()).toString());
  console.log("Owner Balance:", (await myToken.balanceOf(owner.address)).toString());
}

main();
```

## 注意事项

1. **测试网ETH**: 确保你的钱包有足够的Sepolia ETH支付Gas费
2. **WETH**: 在添加流动性前需要先将ETH换成WETH
3. **价格范围**: 选择合适的流动性价格范围
4. **手续费等级**: 根据你的代币特性选择合适的手续费等级

这个完整的流程将帮助你在Sepolia测试网上成功发行ERC20代币并在Uniswap V3上创建流动性池。
