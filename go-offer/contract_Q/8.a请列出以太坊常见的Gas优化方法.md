å¥½çš„ï¼Œè¿™é‡Œä¸ºä½ æ•´ç†äº†ä¸€ä»½å…¨é¢çš„ä»¥å¤ªåŠGasä¼˜åŒ–æ–¹æ³•æŒ‡å—ï¼Œæ¶µç›–äº†ä»åŸºç¡€åˆ°é«˜çº§çš„å„ç§æŠ€å·§ã€‚

## ğŸ¯ æ ¸å¿ƒGasä¼˜åŒ–åŸåˆ™

### 1. å­˜å‚¨ä¼˜åŒ–ï¼ˆæœ€å…³é”®çš„ä¼˜åŒ–ï¼‰

**å­˜å‚¨æ“ä½œæ˜¯Gasæ¶ˆè€—çš„ä¸»è¦æ¥æºï¼š**
- SSTOREï¼ˆå†™å…¥å­˜å‚¨ï¼‰ï¼š~20,000 Gasï¼ˆé¦–æ¬¡å†™å…¥ï¼‰
- SLOADï¼ˆè¯»å–å­˜å‚¨ï¼‰ï¼š~2,100 Gas

#### âœ… å­˜å‚¨ä¼˜åŒ–æ–¹æ³•ï¼š

```solidity
// âŒ ç³Ÿç³•çš„å­˜å‚¨ä½¿ç”¨
contract Inefficient {
    uint256 public count;
    mapping(address => uint256) public balances;
    
    function update() public {
        count += 1;                    // æ˜‚è´µçš„å­˜å‚¨å†™å…¥
        balances[msg.sender] += 100;   // å¦ä¸€ä¸ªå­˜å‚¨å†™å…¥
    }
}

// âœ… ä¼˜åŒ–ç‰ˆæœ¬
contract Efficient {
    uint256 private _count;
    mapping(address => uint256) private _balances;
    
    function update() public {
        // æ‰¹é‡æ›´æ–°ï¼Œå‡å°‘å­˜å‚¨å†™å…¥æ¬¡æ•°
        uint256 newCount = _count + 1;
        uint256 newBalance = _balances[msg.sender] + 100;
        
        _count = newCount;
        _balances[msg.sender] = newBalance;
    }
}
```

#### å­˜å‚¨æ‰“åŒ…ï¼ˆStorage Packingï¼‰
```solidity
// âŒ æµªè´¹å­˜å‚¨
contract BadPacking {
    bool flag1;     // æ§½ 0 (åªç”¨äº†1å­—èŠ‚)
    address addr1;  // æ§½ 1 
    bool flag2;     // æ§½ 2 (åªç”¨äº†1å­—èŠ‚)
    uint8 number;   // æ§½ 3
    // æ€»å…±: 4ä¸ªå­˜å‚¨æ§½
}

// âœ… ä¼˜åŒ–æ‰“åŒ…
contract GoodPacking {
    bool flag1;     // æ‰€æœ‰å˜é‡æ‰“åŒ…åˆ°
    address addr1;  // æ§½ 0
    bool flag2;     // 
    uint8 number;   // 
    // æ€»å…±: 1ä¸ªå­˜å‚¨æ§½ (èŠ‚çœ75% Gas!)
}
```

### 2. å†…å­˜å’ŒCalldataä¼˜åŒ–

```solidity
// âœ… å¯¹åªè¯»æ•°æ®ä½¿ç”¨calldata
function processData(bytes calldata data) external {
    // calldataæ¯”memoryæ›´çœGasï¼ˆå¯¹äºå¤–éƒ¨å‡½æ•°ï¼‰
}

// âœ… æ‰¹é‡å¤„ç†å‡å°‘äº¤æ˜“æ¬¡æ•°
function batchTransfer(address[] calldata recipients, uint256[] calldata amounts) external {
    for (uint i = 0; i < recipients.length; i++) {
        _transfer(recipients[i], amounts[i]);
    }
}
```

### 3. å‡½æ•°ä¿®é¥°ç¬¦ä¼˜åŒ–

```solidity
// âœ… æ­£ç¡®ä½¿ç”¨viewå’Œpure
function calculate(uint256 a, uint256 b) public pure returns (uint256) {
    return a + b; // å…è´¹çš„å¤–éƒ¨è°ƒç”¨
}

function getBalance(address user) public view returns (uint256) {
    return balances[user]; // å…è´¹çš„å¤–éƒ¨è°ƒç”¨
}
```

---

## ğŸ”§ å…·ä½“ä¼˜åŒ–æŠ€å·§

### 1. å˜é‡æ’åºå’Œæ‰“åŒ…
```solidity
contract OptimizedLayout {
    // âœ… å°†å°ç±»å‹å˜é‡æ”¾åœ¨ä¸€èµ·
    address owner;          // 20å­—èŠ‚
    uint64 lastUpdate;      // 8å­—èŠ‚  
    bool isActive;          // 1å­—èŠ‚
    uint8 version;          // 1å­—èŠ‚
    // æ€»å…±: 30å­—èŠ‚ â†’ æ‰“åŒ…åœ¨1ä¸ªæ§½ä¸­
    
    // å¤§å˜é‡å•ç‹¬å£°æ˜
    uint256 totalSupply;    // éœ€è¦æ•´ä¸ªæ§½
    mapping(address => uint256) balances;
    
    // âŒ é¿å…åœ¨æ‰“åŒ…å˜é‡ä¹‹é—´æ’å…¥å¤§å˜é‡
    // bool flag1;
    // uint256 bigVar;    // è¿™ä¼šæ‰“æ–­æ‰“åŒ…!
    // bool flag2;
}
```

### 2. ä½¿ç”¨å¸¸é‡å’Œä¸å˜é‡
```solidity
contract Constants {
    // âœ… å¸¸é‡ï¼ˆç¼–è¯‘æ—¶æ›¿æ¢ï¼Œä¸å å­˜å‚¨ï¼‰
    uint256 public constant MAX_SUPPLY = 1000000 * 10**18;
    address public constant FEE_RECIPIENT = 0x123...;
    
    // âœ… ä¸å¯å˜é‡ï¼ˆæ„é€ å‡½æ•°è®¾ç½®ï¼Œæ¯”å¸¸é‡æ›´çµæ´»ï¼‰
    address public immutable FACTORY;
    uint256 public immutable CREATED_AT;
    
    constructor() {
        FACTORY = msg.sender;
        CREATED_AT = block.timestamp;
    }
}
```

### 3. å¾ªç¯ä¼˜åŒ–
```solidity
contract LoopOptimization {
    uint256[] public items;
    
    // âŒ ä½æ•ˆå¾ªç¯
    function sumItemsBad() public view returns (uint256) {
        uint256 total = 0;
        for (uint256 i = 0; i < items.length; i++) {
            total += items[i]; // æ¯æ¬¡å¾ªç¯éƒ½è¯»å–æ•°ç»„é•¿åº¦
        }
        return total;
    }
    
    // âœ… ä¼˜åŒ–å¾ªç¯
    function sumItemsGood() public view returns (uint256) {
        uint256 total = 0;
        uint256 length = items.length; // ç¼“å­˜é•¿åº¦
        for (uint256 i = 0; i < length; i++) {
            total += items[i];
        }
        return total;
    }
    
    // âœ… æ›´è¿›ä¸€æ­¥çš„ä¼˜åŒ–
    function sumItemsBest() public view returns (uint256 total) {
        uint256 length = items.length;
        for (uint256 i = 0; i < length; ) {
            total += items[i];
            unchecked { i++; } // ç§»é™¤æº¢å‡ºæ£€æŸ¥ï¼ˆåœ¨ç¡®å®šä¸ä¼šæº¢å‡ºæ—¶ï¼‰
        }
    }
}
```

### 4. é”™è¯¯å¤„ç†ä¼˜åŒ–
```solidity
contract ErrorOptimization {
    // âŒ ä¼ ç»Ÿrequireï¼ˆæ¶ˆè€—æ›´å¤šGasï¼‰
    function withdrawOld(uint256 amount) public {
        require(amount <= balances[msg.sender], "Insufficient balance");
        require(amount > 0, "Amount must be positive");
        balances[msg.sender] -= amount;
    }
    
    // âœ… è‡ªå®šä¹‰é”™è¯¯ï¼ˆèŠ‚çœGasï¼‰
    error InsufficientBalance(uint256 available, uint256 required);
    error InvalidAmount();
    
    function withdrawNew(uint256 amount) public {
        if (amount > balances[msg.sender]) {
            revert InsufficientBalance(balances[msg.sender], amount);
        }
        if (amount == 0) revert InvalidAmount();
        
        balances[msg.sender] -= amount;
    }
}
```

### 5. ä½å›¾å’Œå¤§è§„æ¨¡å¸ƒå°”å­˜å‚¨
```solidity
contract BitmapOptimization {
    // âŒ ä½æ•ˆçš„å¸ƒå°”å­˜å‚¨
    mapping(uint256 => bool) public isUsed; // æ¯ä¸ªboolå ç”¨1ä¸ªå­˜å‚¨æ§½!
    
    // âœ… ä½¿ç”¨ä½å›¾
    mapping(uint256 => uint256) public usedBitmaps;
    
    function setUsed(uint256 index) public {
        uint256 bucket = index / 256;
        uint256 bit = index % 256;
        usedBitmaps[bucket] |= (1 << bit);
    }
    
    function isUsedOptimized(uint256 index) public view returns (bool) {
        uint256 bucket = index / 256;
        uint256 bit = index % 256;
        return (usedBitmaps[bucket] & (1 << bit)) != 0;
    }
}
```

### 6. æ•°å­¦è¿ç®—ä¼˜åŒ–
```solidity
contract MathOptimization {
    // âœ… ä½¿ç”¨ç§»ä½ä»£æ›¿ä¹˜é™¤ï¼ˆ2çš„å¹‚æ¬¡æ–¹æ—¶ï¼‰
    function multiplyBy16(uint256 x) public pure returns (uint256) {
        return x << 4; // è€Œä¸æ˜¯ x * 16
    }
    
    function divideBy8(uint256 x) public pure returns (uint256) {
        return x >> 3; // è€Œä¸æ˜¯ x / 8
    }
    
    // âœ… ä½¿ç”¨uncheckedå—ï¼ˆå½“ç¡®å®šä¸ä¼šæº¢å‡ºæ—¶ï¼‰
    function safeIncrement(uint256 x) public pure returns (uint256) {
        unchecked {
            return x + 1; // èŠ‚çœGasï¼Œç§»é™¤æº¢å‡ºæ£€æŸ¥
        }
    }
    
    // âœ… é¢„è®¡ç®—å’Œç¼“å­˜
    uint256 private constant PRECISION = 1e18;
    
    function calculateWithPrecision(uint256 value) public pure returns (uint256) {
        return (value * PRECISION) / 100;
    }
}
```

---

## ğŸš€ é«˜çº§ä¼˜åŒ–æŠ€æœ¯

### 1. ä»£ç†æ¨¡å¼å’Œå­˜å‚¨å¸ƒå±€
```solidity
// EIP-1967 å­˜å‚¨æ§½
contract ProxyOptimization {
    bytes32 private constant _IMPLEMENTATION_SLOT = 
        0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc;
    
    // å¯å‡çº§åˆçº¦ä¸­ä¿æŒå­˜å‚¨æ§½å…¼å®¹æ€§
    struct StorageLayout {
        address owner;
        uint256 totalSupply;
        mapping(address => uint256) balances;
        // æŒ‰é¡ºåºæ·»åŠ æ–°å˜é‡ï¼Œä¸è¦ä¿®æ”¹ç°æœ‰é¡ºåº
    }
}
```

### 2. æ±‡ç¼–ä¼˜åŒ–ï¼ˆé«˜çº§ç”¨æ³•ï¼‰
```solidity
contract AssemblyOptimization {
    function getBalanceAssembly(address account) public view returns (uint256) {
        bytes32 slot = keccak256(abi.encode(account, uint256(1)));
        uint256 balance;
        assembly {
            balance := sload(slot)
        }
        return balance;
    }
    
    // Gasé«˜æ•ˆçš„è½¬ç§»
    function transferOptimized(address to, uint256 amount) public {
        // ä½¿ç”¨æ±‡ç¼–è¿›è¡Œé«˜æ•ˆçš„å­˜å‚¨æ“ä½œ
        assembly {
            // ä¼˜åŒ–åçš„é€»è¾‘
        }
    }
}
```

### 3. äº‹ä»¶ä»£æ›¿å­˜å‚¨
```solidity
contract EventOptimization {
    // âŒ å­˜å‚¨æ‰€æœ‰æ•°æ®ï¼ˆæ˜‚è´µï¼‰
    mapping(address => string) public userNames;
    
    // âœ… ä½¿ç”¨äº‹ä»¶è®°å½•ï¼Œé“¾ä¸‹å­˜å‚¨
    event UserNameUpdated(address indexed user, string name);
    
    function setName(string calldata name) public {
        // å¦‚æœä¸éœ€è¦åœ¨åˆçº¦ä¸­è®¿é—®ç”¨æˆ·åï¼Œåªä½¿ç”¨äº‹ä»¶
        emit UserNameUpdated(msg.sender, name);
        // æ¯”å­˜å‚¨åˆ°mappingèŠ‚çœå¤§é‡Gas
    }
}
```

### 4. æ‰¹é‡æ“ä½œæ¨¡å¼
```solidity
contract BatchOperations {
    mapping(address => uint256) public balances;
    
    // âœ… æ‰¹é‡è½¬è´¦
    function batchTransfer(
        address[] calldata recipients,
        uint256[] calldata amounts
    ) external {
        require(recipients.length == amounts.length, "Length mismatch");
        
        uint256 total;
        for (uint256 i = 0; i < amounts.length; ) {
            total += amounts[i];
            unchecked { i++; }
        }
        
        require(balances[msg.sender] >= total, "Insufficient balance");
        
        balances[msg.sender] -= total;
        for (uint256 i = 0; i < recipients.length; ) {
            balances[recipients[i]] += amounts[i];
            unchecked { i++; }
        }
    }
}
```

---

## ğŸ“Š Gasæˆæœ¬å‚è€ƒè¡¨

| æ“ä½œ | Gasæˆæœ¬ | ä¼˜åŒ–å»ºè®® |
|------|---------|----------|
| **SSTOREï¼ˆé¦–æ¬¡å†™å…¥ï¼‰** | 22,100 | ä½¿ç”¨æ‰“åŒ…ï¼Œå‡å°‘å†™å…¥ |
| **SSTOREï¼ˆéé›¶â†’é›¶ï¼‰** | 5,000 + é€€æ¬¾ | æ¸…ç†ä¸éœ€è¦çš„å­˜å‚¨ |
| **SLOAD** | 2,100 | ç¼“å­˜åˆ°å†…å­˜å˜é‡ |
| **CALL** | 2,600+ | æ‰¹é‡è°ƒç”¨ |
| **Keccak256** | 30-60 | é¢„è®¡ç®—å“ˆå¸Œ |
| **ECRECOVER** | 3,000 | è€ƒè™‘å…¶ä»–ç­¾åæ–¹æ¡ˆ |

---

## ğŸ› ï¸ å¼€å‘å·¥ä½œæµä¼˜åŒ–

### 1. ä½¿ç”¨æœ€æ–°Solidityç‰ˆæœ¬
```json
// pragma solidity ^0.8.21; // æ€»æ˜¯ä½¿ç”¨æœ€æ–°ç¨³å®šç‰ˆ
// æ–°ç‰ˆæœ¬é€šå¸¸åŒ…å«Gasä¼˜åŒ–æ”¹è¿›
```

### 2. ç¼–è¯‘å™¨ä¼˜åŒ–è®¾ç½®
```json
// hardhat.config.js
module.exports = {
  solidity: {
    version: "0.8.21",
    settings: {
      optimizer: {
        enabled: true,
        runs: 200,    // é’ˆå¯¹å‡½æ•°è°ƒç”¨ä¼˜åŒ–
        // runs: 1000, // é’ˆå¯¹æ„é€ å‡½æ•°ä¼˜åŒ–ï¼ˆå¦‚æœéƒ¨ç½²æˆæœ¬é‡è¦ï¼‰
      },
      viaIR: true,    // å¯ç”¨IRç”Ÿæˆå™¨ï¼ˆæ›´å¥½çš„ä¼˜åŒ–ï¼‰
    },
  },
};
```

### 3. æµ‹è¯•å’ŒéªŒè¯
```javascript
// ä½¿ç”¨GasæŠ¥å‘Šå·¥å…·
const { expect } = require("chai");

describe("Gas Optimization", function () {
  it("should use less gas", async function () {
    const tx = await contract.optimizedFunction();
    const receipt = await tx.wait();
    
    console.log("Gas used:", receipt.gasUsed.toString());
    expect(receipt.gasUsed).to.be.lt(50000); // Gasä¸Šé™æµ‹è¯•
  });
});
```

---

## ğŸ¯ æ€»ç»“ï¼šæœ€é‡è¦çš„ä¼˜åŒ–ç­–ç•¥

1. **å­˜å‚¨æ‰“åŒ…** - æœ€å¤§çš„èŠ‚çœæ¥æº
2. **æ‰¹é‡æ“ä½œ** - å‡å°‘äº¤æ˜“æ¬¡æ•°  
3. **ä½¿ç”¨calldata** - å¤–éƒ¨å‡½æ•°çš„å‚æ•°ä¼ é€’
4. **è‡ªå®šä¹‰é”™è¯¯** - ä»£æ›¿requireå­—ç¬¦ä¸²
5. **uncheckedå—** - å®‰å…¨çš„ç®—æœ¯ä¼˜åŒ–
6. **å¸¸é‡å’Œä¸å¯å˜é‡** - é¿å…å­˜å‚¨è¯»å–
7. **ä½å›¾** - å¤§è§„æ¨¡å¸ƒå°”å€¼å­˜å‚¨
8. **æœ€æ–°å·¥å…·é“¾** - ç¼–è¯‘å™¨å’Œæ¡†æ¶ä¼˜åŒ–

**è®°ä½ä¼˜åŒ–åŸåˆ™**ï¼š
> å…ˆæµ‹é‡ï¼Œåä¼˜åŒ–ã€‚ä½¿ç”¨åƒHardhat Gas Reporterè¿™æ ·çš„å·¥å…·æ¥è¯†åˆ«çœŸæ­£çš„ç“¶é¢ˆï¼Œè€Œä¸æ˜¯çŒœæµ‹ï¼

è¿™äº›ä¼˜åŒ–æ–¹æ³•ç»“åˆèµ·æ¥ï¼Œå¯ä»¥å°†Gasæˆæœ¬é™ä½50-90%ï¼Œè®©ä½ çš„åˆçº¦æ›´åŠ ç»æµé«˜æ•ˆï¼
