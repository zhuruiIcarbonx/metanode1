# 一、XXXXXX

在 **Hardhat** 或 **Foundry** 中使用 **Mainnet Fork**（主网分叉）进行测试时，**不需要真实消耗 ETH**。这是因为本地分叉环境会模拟主网状态，所有操作均在本地开发节点上运行，不会触及真实的以太坊网络。以下是具体说明：

---

### 1. **原理**
   - **主网分叉** 是工具（如 Hardhat/Foundry）通过节点 provider（如 Alchemy、Infura）获取主网最新状态的快照，并在本地创建一个完全一样的虚拟链。
   - 测试时使用的 ETH 是**本地模拟的**，可以自由分配（例如给自己账户 10000 ETH），与真实主网无关。

---

### 2. **Hardhat 示例**
   - **配置分叉**（在 `hardhat.config.js` 中）：
     ```javascript
     module.exports = {
       networks: {
         hardhat: {
           forking: {
             url: "https://eth-mainnet.alchemyapi.io/v2/YOUR_API_KEY", // 主网RPC
             blockNumber: 17654321, // （可选）指定区块高度
           },
         },
       },
     };
     ```
   - **测试中获取 ETH**：
     ```javascript
     const [sender] = await ethers.getSigners();
     console.log(await sender.getBalance()); // 默认有巨量测试ETH
     ```

---

### 3. **Foundry 示例**
   - 启动分叉环境：
     ```bash
     anvil --fork-url https://eth-mainnet.alchemyapi.io/v2/YOUR_API_KEY
     ```
   - 测试中直接使用 `cast` 或 `forge` 命令时，所有 ETH 均为模拟，无需真实资金。

---

### 4. **注意事项**
   - **API 限额**：免费 RPC 可能有调用次数限制，高频测试建议用专业节点服务。
   - **状态持久性**：默认分叉是临时的，重启后重置。可通过缓存（如 Hardhat 的 `forking` 配置）优化速度。
   - **依赖外部节点**：若 RPC 服务不可用，分叉功能会失效。

---

### 5. **为什么安全？**
   - 私钥和交易仅在本地生效，不会广播到主网。
   - 测试 ETH 是工具自动生成的，与真实链无关。

放心使用分叉测试，无需担心真实资产消耗！


# 二、XXXXXX



在 **Hardhat** 或 **Foundry** 中进行 **主网分叉测试（Mainnet Forking）** 时，**不需要真实消耗 ETH**。以下是具体说明：

---

### 1. **主网分叉测试的本质**
主网分叉测试是通过工具（如 Hardhat 或 Foundry）**本地模拟以太坊主网状态**，而非直接在真实主网上操作。所有交易、合约交互、Gas 消耗等均在 **隔离的本地环境中运行**，不会影响真实链上的资产。

---

### 2. **如何实现免真实 ETH 的测试**
- **模拟账户余额**  
  工具允许开发者：
  - **预设测试账户余额**：在配置文件中指定测试账户的初始 ETH 余额（例如 `hardhat.config.ts` 中的 `accounts` 配置）。
  - **动态修改余额**：通过测试脚本直接调整账户余额（如 Hardhat 的 `hardhat_setBalance` RPC 调用）。

- **Gas 消耗模拟**  
  本地节点（如 Hardhat Network 或 Anvil）会模拟 Gas 消耗和交易费用，但这些费用仅存在于测试环境中，**不会扣除真实 ETH**。

---

### 3. **具体工具操作**
#### **Hardhat**
- 启动分叉测试：
  ```bash
  npx hardhat node --fork https://mainnet.infura.io/v3/YOUR_INFURA_KEY
  ```
- 测试脚本中分配 ETH：
  ```typescript
  await hre.network.provider.send("hardhat_setBalance", [
    "0xYourTestAddress",
    "0x1000000000000000000000000", // 10^24  wei (约 10^6 ETH)
  ]);
  ```

#### **Foundry**
- 启动分叉测试：
  ```bash
  anvil --fork-url https://mainnet.infura.io/v3/YOUR_INFURA_KEY
  ```
- 测试脚本中分配 ETH：
  ```solidity
  vm.deal(address(this), 100 ether); // 直接增加合约余额
  ```

---

### 4. **注意事项**
- **外部合约调用**：若测试中调用了主网真实合约（如 DAI 合约），需确保分叉节点已同步相关状态，但 **不会影响真实链上的资产**。
- **Gas 价格波动**：测试环境中的 Gas 价格可能与主网不同，需通过 `tx.gasPrice` 或 `block.basefee` 手动调整。

---

### 总结
通过 **Hardhat** 或 **Foundry** 的主网分叉功能，开发者可以**完全免费**地在本地复现主网环境，无需消耗真实 ETH。所有操作仅用于测试，极大降低了开发成本和风险。





